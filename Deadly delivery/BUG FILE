-- Infinity Stamina - Aggressive Loop Version
-- Multiple loops to ensure stamina NEVER decreases

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

print("‚è≥ Loading Infinity Stamina (Loop Version)...")
task.wait(1)

-- Load required modules
local Value = require(ReplicatedStorage.Shared.Core.Value)
local Config = require(ReplicatedStorage.Config)

-- Get max stamina value
local maxStamina = Config.Property.StaminaSystem.stamina.default

print("üìä Max Stamina:", maxStamina)
print("üîß Starting aggressive loops...")

-- Set initial values
Value.Stamina = maxStamina
Config.Property.StaminaSystem.runStaminaConsume = 0
Config.Property.StaminaSystem.naturalRecovery = 99999
Config.Property.StaminaSystem.delayRecoveryTime = 0
Value.StaminaConsumeMutil = 0

print("‚úì Initial config set")

-- ===== LOOP 1: RENDERSTEPPED (Highest priority, runs before rendering) =====
local loop1 = RunService.RenderStepped:Connect(function()
    Value.Stamina = maxStamina
    Value.StaminaConsumeMutil = 0
    Config.Property.StaminaSystem.runStaminaConsume = 0
end)

print("‚úì Loop 1 (RenderStepped) active")

-- ===== LOOP 2: HEARTBEAT (Runs every frame) =====
local loop2 = RunService.Heartbeat:Connect(function()
    Value.Stamina = maxStamina
    Config.Property.StaminaSystem.naturalRecovery = 99999
end)

print("‚úì Loop 2 (Heartbeat) active")

-- ===== LOOP 3: STEPPED (Physics step) =====
local loop3 = RunService.Stepped:Connect(function()
    if Value.Stamina ~= maxStamina then
        Value.Stamina = maxStamina
    end
end)

print("‚úì Loop 3 (Stepped) active")

-- ===== LOOP 4: FAST WHILE LOOP (Background task) =====
local loop4Running = true
task.spawn(function()
    while loop4Running do
        Value.Stamina = maxStamina
        Value.StaminaConsumeMutil = 0
        task.wait() -- Runs as fast as possible
    end
end)

print("‚úì Loop 4 (Fast while) active")

-- ===== LOOP 5: MODERATE WHILE LOOP (Every 0.05 seconds) =====
local loop5Running = true
task.spawn(function()
    while loop5Running do
        Value.Stamina = maxStamina
        Config.Property.StaminaSystem.runStaminaConsume = 0
        Config.Property.StaminaSystem.naturalRecovery = 99999
        Config.Property.StaminaSystem.delayRecoveryTime = 0
        task.wait(0.05)
    end
end)

print("‚úì Loop 5 (Moderate while) active")

-- ===== LOOP 6: SLOW WHILE LOOP (Every 0.5 seconds - for safety) =====
local loop6Running = true
task.spawn(function()
    while loop6Running do
        -- Force all values
        Value.Stamina = maxStamina
        Value.StaminaConsumeMutil = 0
        Config.Property.StaminaSystem.runStaminaConsume = 0
        Config.Property.StaminaSystem.naturalRecovery = 99999
        Config.Property.StaminaSystem.delayRecoveryTime = 0
        task.wait(0.5)
    end
end)

print("‚úì Loop 6 (Safety check) active")

-- ===== HIDE STAMINA BAR =====
task.spawn(function()
    while true do
        pcall(function()
            local StaminaFrame = Players.LocalPlayer.PlayerGui.Main.HomePage.Property.Stamina
            StaminaFrame.Visible = false
            StaminaFrame.Frame.Bar.Size = UDim2.fromScale(1, 1)
        end)
        task.wait(1)
    end
end)

print("‚úì UI loop active")

-- ===== BUFF SYSTEM PROTECTION =====
task.spawn(function()
    pcall(function()
        local Buff = require(ReplicatedStorage.Shared.Features.Buff)
        
        -- Keep overriding consumption buffs
        task.spawn(function()
            while true do
                pcall(function()
                    Buff.OnChanged("StaminaConsumeRate", function()
                        Config.Property.StaminaSystem.runStaminaConsume = 0
                        Value.StaminaConsumeMutil = 0
                    end, { replay = true })
                end)
                task.wait(1)
            end
        end)
        
        -- Keep overriding regen buffs
        task.spawn(function()
            while true do
                pcall(function()
                    Buff.OnChanged("StaminaRegenRate", function()
                        Config.Property.StaminaSystem.naturalRecovery = 99999
                    end, { replay = true })
                end)
                task.wait(1)
            end
        end)
        
        -- Block negative stamina
        Buff.OnApply("Stamina", function(arg1, arg2)
            local change = arg2:Get()
            if change < 0 then
                Value.Stamina = maxStamina
            end
        end)
        
        print("‚úì Buff protection loops active")
    end)
end)

-- ===== MONITORING LOOP =====
local monitoring = true
task.spawn(function()
    local checkCount = 0
    while monitoring do
        checkCount = checkCount + 1
        local currentStamina = Value.Stamina
        local percentage = math.floor((currentStamina / maxStamina) * 100)
        
        print(string.format("üí™ [Check #%d] Stamina: %.0f/%d (%d%%) | All loops running", 
            checkCount, currentStamina, maxStamina, percentage))
        
        task.wait(5)
    end
end)

print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
print("‚úÖ INFINITY STAMINA ACTIVE!")
print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
print("")
print("üî• 6 AGGRESSIVE LOOPS RUNNING:")
print("  ‚úì Loop 1: RenderStepped")
print("  ‚úì Loop 2: Heartbeat")
print("  ‚úì Loop 3: Stepped")
print("  ‚úì Loop 4: Fast while (instant)")
print("  ‚úì Loop 5: Moderate while (0.05s)")
print("  ‚úì Loop 6: Safety check (0.5s)")
print("  ‚úì UI hide loop")
print("  ‚úì Buff protection loops")
print("")
print("Your stamina is LOCKED at maximum!")
print("Press F9 to see loop status")
print("")
print("To disable all loops: _G.StopAllLoops()")

-- Disable function - stops ALL loops
_G.StopAllLoops = function()
    monitoring = false
    loop4Running = false
    loop5Running = false
    loop6Running = false
    
    if loop1 then loop1:Disconnect() end
    if loop2 then loop2:Disconnect() end
    if loop3 then loop3:Disconnect() end
    
    print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    print("‚ùå ALL LOOPS STOPPED!")
    print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ")
    print("Infinity Stamina has been disabled")
end

print("üéÆ All loops are now running!")
print("üéÆ Your stamina will NEVER decrease!")
